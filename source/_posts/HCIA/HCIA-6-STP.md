---
title: HCIA -- 6 -- STP
date: 2023-08-30 20:35:26
tags: 
   - HCIA
   - STP
---
## 一、二层广播风暴的产生

1. 交换机的工作原理中存在缺陷，交换机在无法找到目标网络时会发送广播。
2. 弱管理员将网络的物理拓扑结构连接成环路的话，则在二层网络中，将会引起广播风暴。
3. 广播风暴会导致交换机耗尽自身全部资源，致使硬件设备死机或硬件损坏。

## 二、STP的工作原理

1. STP将一个有环网络中的某一条链路的某一个端口从逻辑上down掉，保证网络无环且正常运行；当其他任意一条主链路发生故障时，之前从逻辑上down掉的端口会自动激活，重新恢复连接，保证通讯的正常运行。

### 2. STP的算法

STP若想将一个有环的网络最终生成为一个无环的拓扑结构，一共需要 3 步：

#### 2.1 选择根网桥【root】

每台交换机都有一个独立且唯一的BID【Bridge ID】
BID = `网桥优先级` ➕ `网桥 MAC 地址`
网桥的优先级取值范围：`0 —— 61440`
默认值为：`32768`
在选择根网桥时，BID最小的将胜出。
因此在进行选举时，各个网桥先比较各自的优先级值，若优先级值完全一样时，再比较各个网桥的 MAC 地址。
`注：在手动配置 STP 的优先级时，改值必须能够被 2 整除，且是 16 的整数倍；管理员能够配置的最小值为4096`
STP配置优先级时的常用数值：`4096、8192、24576、32768`

#### 2.2 选择根端口【RP】

根端口时在非根网桥上选举出来的，在非根网桥上选择根端口，共需4步：

   1. 最低的到达根网桥的路径开销
   2. 最低的发送方网桥ID
   3. 最低的端口优先级
   4. 发送方最低的端口ID

`注：端口ID【Port ID】`

PID = `端口优先级` ➕ `端口编号`
端口优先级的取值范围：`0 — 240`
`默认值为：128`
端口编号：E0/0/1【左起第一个 0 表示板卡号、中间的 0 表示模块号、最右侧的 1 表示槽位号（端口编号）】
E0/0/1 的 PID = 128.1

#### 2.3 选择指定端口【DP】

- 在每个网段上，选择1个指定端口
- 根网桥上的所有端口均为指定端口
- 非根网桥上指定端口选举的过程分为4步：
  1. BPDU 中的根网桥 ID
  2. 最低的到达根网桥的路径开销
  3. 发送方的网桥 ID
  4. 若优先级相同，则具有最低 MAC 地址

### 3 BPDU 【Bridge Protocol Data Unit ｜ 桥接协议数据单元】

1. 各个交换机使用 BPDU 来交换 STP 中要使用的信息
2. BPDU 使用组播方式传递，使用的组播地址为：`01-80-C2-00-00-00`
3. BPDU的种类
   1. 配置BPDU【Configuration BPDU】：用来实现 STP 的首次计算
   2. 拓扑变更通告【TCN】BPDU：用来在STP发生变化的时候使用

## 三. STP的5种端口状态

1. 禁用[Disable]：不发送 BPDU， 不接受 BPDU，不学习 MAC 地址，不会转发数据。
2. 阻塞[Discarding]：不发送 BPDU，**接受 BPDU**，不学习 MAC 地址，不会转发数据。
3. 侦听[Listening]：**发送 BPDU，接受 BPDU**， 不学习 MAC 地址，不会转发数据<span style="color:red">【中间态】</span>。
4. 学习[Learning]：**发送 BPDU，接受 BPDU，学习 MAC 地址**，不会转发数据<span style="color:red">【中间态】</span>。
5. 转发[Forwarding]：**发送 BPDU，接受 BPDU，学习 MAC 地址，转发数据。**

## 四. STP的拓扑结构变化

1. 在生成树中，一个阻塞状态的端口从阻塞状态最终恢复至转发状态，一共需要 <span style="color:red;">50s</span>。
2. Discarding 进入 Listening 需要 <span style="color:red;">20s</span> 【Maxage：最大老化时间】。
3. Listening 进入 Learning 需要 <span style="color:red;">15s</span>。
4. Learning 进入 Forwarding 需要 <span style="color:red;">15s</span> 【15s + 15s = 30s Forwarding Dealy ：转发延迟】。
5. 若是非直连链路，端口恢复需要 50s。
6. 若是直连链路，只需 30s 【节省了 20s 的 maxage】。
7. 交换机的 MAC 地址表默认 300s maxage，当STP的拓扑结构发生变化时，STP的TCN BPDU 会立即通知交换机的 MAC 地址表立即刷新，令交换机的 MAC 地址表的刷新时间从 300s 变为 15s 。

## 五. STP的配置

1. 在华为的交换机上，STP技术默认随着设备的启动而自动运行。
2. 更改交换机的优先级

```
stp priority 4096
```

3. 更改当前交换机的STP模式

```
stp mode stp
```

4. 更改STP的路径计算方式

```
stp pathcost-standard dotld-1998
```